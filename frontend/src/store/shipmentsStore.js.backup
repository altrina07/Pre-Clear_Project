// Centralized shipment data store for real-time synchronization between roles
// This simulates a real-time database that all users can access

// Default shipment schema factory
const createDefaultShipment = () => ({
  // Shipment Basics
  referenceId: '',
  title: '',
  mode: 'Air', // Air | Sea | Road | Rail | Courier | Multimodal
  shipmentType: 'International', // Domestic | International
  pickupType: 'Scheduled Pickup', // Scheduled Pickup | Drop-off
  shipDate: '',
  expectedDelivery: '',
  carrier: 'UPS',

  // Shipper
  shipper: {
    company: '',
    contactName: '',
    phone: '',
    email: '',
    address1: '',
    address2: '',
    city: '',
    state: '',
    postalCode: '',
    country: '',
    taxId: '',
    exporterOfRecord: false
  },

  // Consignee
  consignee: {
    company: '',
    contactName: '',
    phone: '',
    email: '',
    address1: '',
    address2: '',
    city: '',
    state: '',
    postalCode: '',
    country: '',
    taxId: '',
    importerOfRecord: false
  },

  // Packages
  packages: [],
  totalWeight: 0,

  // Service & Billing
  serviceLevel: 'Standard', // Standard | Express | Economy | Freight
  incoterm: 'FOB', // FOB, CIF, etc.
  billTo: 'Shipper', // Shipper | Consignee | ThirdParty
  billingAccountNumber: '',
  currency: 'USD',
  declaredValue: 0,
  insuranceRequired: false,

  // Products
  products: [],

  // Compliance
  dangerousGoods: false,
  lithiumBattery: false,
  foodPharmaFlag: false,
  temperatureControlled: false,
  eccn: '',
  exportLicenseRequired: false,
  licenseNumber: '',
  restrictedFlag: false,
  sanctionedCountryFlag: false,
  deniedPartyScreeningResult: 'Clear',

  // Documents
  documents: {
    commercialInvoice: false,
    packingList: false,
    certificateOfOrigin: false,
    exportLicense: false,
    importLicense: false,
    sds: false,
    awb: false,
    bol: false,
    cmr: false,
    others: []
  },

  // Notifications
  notificationEmails: [],
  brokerNotificationEnabled: true,
  visibility: 'public',
  trackingEnabled: true,

  // AI & Broker
  aiComplianceScore: 0,
  aiComplianceStatus: 'not-started', // not-started | in-progress | cleared | issues-found | denied
  aiValidationNotes: '',
  missingDocuments: [],
  suggestedHsCode: '',
  estimatedDutyTax: 0,
  riskLevel: 'low', // low | medium | high | critical
  brokerReviewStatus: 'pending', // pending | approved | rejected | documents-requested
  brokerComments: '',
  brokerRequestedDocs: [],
  brokerReviewedAt: null,

  // Booking & Payment
  token: null,
  tokenGeneratedAt: null,
  status: 'draft', // draft | documents-uploaded | ai-approved | awaiting-broker | token-generated | booked | payment-pending | payment-completed
  bookingStatus: 'not-booked', // not-booked | booked
  paymentTiming: 'Prepaid', // Prepaid | Collect | COD
  paymentStatus: 'pending', // pending | paid | failed | collected
  paymentMethod: '',
  value: 0,

  // System
  createdBy: '',
  createdAt: new Date().toISOString(),
  updatedAt: new Date().toISOString(),
  lastModifiedBy: '',
  auditLogs: []
});

// Mock initial data
const mockShipments = [
  {
    id: 'SHP-001',
    productName: 'Electronic Components',
    productDescription: 'Industrial electronic integrated circuits',
    hsCode: '8541.10.00',
    quantity: '100',
    weight: '25.5',
    value: '5000',
    originCountry: 'CN',
    originCity: 'Shanghai',
    originAddress: '123 Manufacturing St, Shanghai',
    destCountry: 'US',
    destCity: 'New York',
    destAddress: '456 Import Ave, New York, NY',
    status: 'token-generated',
    aiApproval: 'approved',
    aiScore: 94,
    aiEvaluatedAt: '2024-12-02T10:30:00Z',
    brokerApproval: 'approved',
    brokerReviewedAt: '2024-12-02T14:30:00Z',
    token: 'UPS-PCT-87654321',
    tokenGeneratedAt: '2024-12-02T14:35:00Z',
    documents: [
      { name: 'Commercial Invoice', type: 'invoice', uploaded: true, uploadedAt: '2024-12-02T09:00:00Z' },
      { name: 'Packing List', type: 'packing-list', uploaded: true, uploadedAt: '2024-12-02T09:05:00Z' },
      { name: 'Certificate of Origin', type: 'certificate', uploaded: true, uploadedAt: '2024-12-02T09:10:00Z' },
    ],
    createdAt: '2024-12-02T08:00:00Z',
    updatedAt: '2024-12-02T14:35:00Z',
    shipperId: 'shipper-1',
    shipperName: 'ABC Exports'
  },
  {
    id: 'SHP-002',
    productName: 'Textile Goods',
    productDescription: 'Cotton fabric rolls for apparel manufacturing',
    hsCode: '5208.31.00',
    quantity: '500',
    weight: '150',
    value: '12000',
    originCountry: 'IN',
    originCity: 'Mumbai',
    originAddress: '789 Textile Plaza, Mumbai',
    destCountry: 'US',
    destCity: 'Los Angeles',
    destAddress: '321 Fashion Blvd, Los Angeles, CA',
    status: 'awaiting-broker',
    aiApproval: 'approved',
    aiScore: 96,
    aiEvaluatedAt: '2024-12-03T08:00:00Z',
    brokerApproval: 'pending',
    documents: [
      { name: 'Commercial Invoice', type: 'invoice', uploaded: true, uploadedAt: '2024-12-03T07:00:00Z' },
      { name: 'Packing List', type: 'packing-list', uploaded: true, uploadedAt: '2024-12-03T07:05:00Z' },
      { name: 'Certificate of Origin', type: 'certificate', uploaded: true, uploadedAt: '2024-12-03T07:10:00Z' },
    ],
    createdAt: '2024-12-03T06:00:00Z',
    updatedAt: '2024-12-03T08:00:00Z',
    shipperId: 'shipper-1',
    shipperName: 'ABC Exports'
  },
  {
    id: 'SHP-003',
    productName: 'Medical Devices',
    productDescription: 'Diagnostic medical equipment',
    hsCode: '9018.19.00',
    quantity: '20',
    weight: '45',
    value: '25000',
    originCountry: 'JP',
    originCity: 'Tokyo',
    originAddress: '555 MedTech Tower, Tokyo',
    destCountry: 'US',
    destCity: 'Boston',
    destAddress: '789 Hospital Drive, Boston, MA',
    status: 'documents-uploaded',
    aiApproval: 'not-started',
    brokerApproval: 'not-started',
    documents: [
      { name: 'Commercial Invoice', type: 'invoice', uploaded: true, uploadedAt: '2024-12-03T10:00:00Z' },
      { name: 'Packing List', type: 'packing-list', uploaded: true, uploadedAt: '2024-12-03T10:05:00Z' },
      { name: 'Certificate of Origin', type: 'certificate', uploaded: true, uploadedAt: '2024-12-03T10:10:00Z' },
    ],
    createdAt: '2024-12-03T09:00:00Z',
    updatedAt: '2024-12-03T10:10:00Z',
    shipperId: 'shipper-1',
    shipperName: 'ABC Exports'
  },
  {
    id: 'SHP-004',
    productName: 'Industrial Machinery',
    productDescription: 'CNC milling machines',
    hsCode: '8459.10.00',
    quantity: '5',
    weight: '2500',
    value: '150000',
    originCountry: 'CN',
    originCity: 'Shenzhen',
    originAddress: '123 Industrial Park, Shenzhen',
    destCountry: 'US',
    destCity: 'Detroit',
    destAddress: '456 Manufacturing Way, Detroit, MI',
    status: 'document-requested',
    aiApproval: 'approved',
    aiScore: 88,
    aiEvaluatedAt: '2024-12-02T11:00:00Z',
    brokerApproval: 'documents-requested',
    brokerReviewedAt: '2024-12-02T15:00:00Z',
    brokerNotes: 'Please provide updated safety certificates and detailed technical specifications.',
    documents: [
      { name: 'Commercial Invoice', type: 'invoice', uploaded: true, uploadedAt: '2024-12-02T10:00:00Z' },
      { name: 'Packing List', type: 'packing-list', uploaded: true, uploadedAt: '2024-12-02T10:05:00Z' },
      { name: 'Certificate of Origin', type: 'certificate', uploaded: true, uploadedAt: '2024-12-02T10:10:00Z' },
      { name: 'Safety Certificate', type: 'certificate', uploaded: false, requested: true, requestedAt: '2024-12-02T15:00:00Z' },
      { name: 'Technical Specifications', type: 'specification', uploaded: false, requested: true, requestedAt: '2024-12-02T15:00:00Z' },
    ],
    createdAt: '2024-12-02T09:00:00Z',
    updatedAt: '2024-12-02T15:00:00Z',
    shipperId: 'shipper-1',
    shipperName: 'ABC Exports'
  }
];

const mockMessages = [
  {
    id: 'msg-1',
    shipmentId: 'SHP-004',
    sender: 'broker',
    senderName: 'John Broker',
    message: 'Please provide Safety Certificate and Technical Specifications for the CNC machines.',
    timestamp: '2024-12-02T15:00:00Z',
    type: 'document-request'
  },
  {
    id: 'msg-2',
    shipmentId: 'SHP-004',
    sender: 'shipper',
    senderName: 'ABC Exports',
    message: 'We will upload the requested documents within 24 hours.',
    timestamp: '2024-12-02T15:30:00Z',
    type: 'message'
  }
];

const mockNotifications = [
  {
    id: 'notif-1',
    type: 'broker-approval-request',
    title: 'New Approval Request',
    message: 'SHP-002: Textile Goods - Awaiting your review',
    shipmentId: 'SHP-002',
    timestamp: '2024-12-03T08:05:00Z',
    read: false,
    recipientRole: 'broker'
  },
  {
    id: 'notif-2',
    type: 'documents-requested',
    title: 'Documents Requested',
    message: 'SHP-004: Additional documents needed',
    shipmentId: 'SHP-004',
    timestamp: '2024-12-02T15:00:00Z',
    read: false,
    recipientRole: 'shipper'
  }
];

const mockImportExportRules = [
  {
    id: 'rule-1',
    country: 'United States',
    countryCode: 'US',
    productCategory: 'Electronics',
    hsCodeRange: '8541-8548',
    restrictions: ['Require FCC certification', 'Lead content restrictions (RoHS)', 'Energy Star compliance'],
    requiredDocuments: ['Commercial Invoice', 'Packing List', 'FCC Declaration', 'Certificate of Origin'],
    bannedProducts: ['Counterfeit chips', 'Military-grade semiconductors without license'],
    maxValue: 2500,
    additionalNotes: 'Electronic products valued over $2500 require additional FDA review if medical-related.',
    lastUpdated: '2024-11-15T10:00:00Z',
    updatedBy: 'Admin'
  },
  {
    id: 'rule-2',
    country: 'United States',
    countryCode: 'US',
    productCategory: 'Textiles',
    hsCodeRange: '5208-5212',
    restrictions: ['Country of origin labeling required', 'Fiber content declaration', 'No child labor certification'],
    requiredDocuments: ['Commercial Invoice', 'Packing List', 'Certificate of Origin', 'Textile Declaration'],
    bannedProducts: ['Products from sanctioned regions', 'Goods made with forced labor'],
    maxValue: 250,
    additionalNotes: 'Textile shipments over $250 require additional CBP declaration.',
    lastUpdated: '2024-11-20T14:30:00Z',
    updatedBy: 'Admin'
  },
  {
    id: 'rule-3',
    country: 'United States',
    countryCode: 'US',
    productCategory: 'Medical Devices',
    hsCodeRange: '9018-9022',
    restrictions: ['FDA approval required', 'ISO 13485 certification', 'Biocompatibility testing'],
    requiredDocuments: ['Commercial Invoice', 'Packing List', 'FDA Registration', 'ISO Certificate', 'Safety Data Sheet'],
    bannedProducts: ['Unapproved medical devices', 'Counterfeit pharmaceuticals'],
    additionalNotes: 'All medical devices must have FDA establishment registration and device listing.',
    lastUpdated: '2024-11-25T09:00:00Z',
    updatedBy: 'Admin'
  },
  {
    id: 'rule-4',
    country: 'United States',
    countryCode: 'US',
    productCategory: 'Machinery',
    hsCodeRange: '8459-8466',
    restrictions: ['OSHA compliance required', 'Safety certification', 'Export license for dual-use items'],
    requiredDocuments: ['Commercial Invoice', 'Packing List', 'Safety Certificate', 'Technical Specifications', 'Certificate of Origin'],
    bannedProducts: ['Dual-use items without export license', 'Products violating EPA regulations'],
    maxWeight: 5000,
    additionalNotes: 'Heavy machinery over 5000kg requires special handling permits.',
    lastUpdated: '2024-12-01T11:00:00Z',
    updatedBy: 'Admin'
  }
];

// In-memory store (simulates a real-time database)
class ShipmentsStore {
  constructor() {
    this.shipments = [...mockShipments];
    this.messages = [...mockMessages];
    this.notifications = [...mockNotifications];
    this.importExportRules = [...mockImportExportRules];
    this.listeners = new Set();
  }

  // Subscribe to changes
  subscribe(callback) {
    this.listeners.add(callback);
    return () => this.listeners.delete(callback);
  }

  // Notify all listeners
  notify() {
    this.listeners.forEach(callback => callback());
  }

  // Get all shipments
  getAllShipments() {
    return [...this.shipments];
  }

  // Get shipment by ID
  getShipmentById(id) {
    return this.shipments.find(s => s.id === id);
  }

  // Get shipments by status
  getShipmentsByStatus(status) {
    return this.shipments.filter(s => s.status === status);
  }

  // Get shipments awaiting broker review (AI approved, broker pending)
  getShipmentsAwaitingBroker() {
    return this.shipments.filter(
      s => s.aiApproval === 'approved' && 
           (s.brokerApproval === 'pending' || s.brokerApproval === 'not-started')
    );
  }

  // Get shipments with document requests
  getShipmentsWithDocumentRequests() {
    return this.shipments.filter(s => s.status === 'document-requested');
  }

  // Create or update shipment
  saveShipment(shipment) {
    const index = this.shipments.findIndex(s => s.id === shipment.id);
    shipment.updatedAt = new Date().toISOString();
    
    const isNewShipment = index < 0;
    
    if (index >= 0) {
      this.shipments[index] = shipment;
    } else {
      this.shipments.push(shipment);
    }
    
    // Add notification for broker when new shipment is created
    if (isNewShipment) {
      this.addNotification({
        id: `notif-${Date.now()}-${Math.random()}`,
        type: 'shipment-created',
        title: 'New Shipment Created',
        message: `${shipment.id}: ${shipment.productName} - ${shipment.originCountry} â†’ ${shipment.destCountry}`,
        shipmentId: shipment.id,
        timestamp: new Date().toISOString(),
        read: false,
        recipientRole: 'broker'
      });
    }
    
    this.notify();
  }

  // Update shipment status
  updateShipmentStatus(id, status) {
    const shipment = this.getShipmentById(id);
    if (shipment) {
      shipment.status = status;
      shipment.updatedAt = new Date().toISOString();
      this.saveShipment(shipment);
    }
  }

  // Update AI approval
  updateAIApproval(id, approval, aiResults, score) {
    const shipment = this.getShipmentById(id);
    if (shipment) {
      shipment.aiApproval = approval;
      shipment.aiScore = score;
      shipment.aiResults = aiResults;
      shipment.aiEvaluatedAt = new Date().toISOString();
      
      if (approval === 'approved') {
        shipment.status = 'ai-approved';
      } else {
        shipment.status = 'denied';
      }
      
      this.saveShipment(shipment);
    }
  }

  // Request broker approval
  requestBrokerApproval(id) {
    const shipment = this.getShipmentById(id);
    if (shipment && shipment.aiApproval === 'approved') {
      shipment.brokerApproval = 'pending';
      shipment.status = 'awaiting-broker';
      this.saveShipment(shipment);
      
      // Add notification for broker
      this.addNotification({
        id: `notif-${Date.now()}-${Math.random()}`,
        type: 'broker-approval-request',
        title: 'New Broker Approval Request',
        message: `${shipment.id}: ${shipment.productName} - Ready for review`,
        shipmentId: shipment.id,
        timestamp: new Date().toISOString(),
        read: false,
        recipientRole: 'broker'
      });
    }
  }

  // Broker approves shipment
  brokerApprove(id, notes) {
    const shipment = this.getShipmentById(id);
    if (shipment) {
      shipment.brokerApproval = 'approved';
      shipment.brokerReviewedAt = new Date().toISOString();
      shipment.brokerNotes = notes;
      
      // Generate token
      const token = `UPS-PCT-${Math.random().toString(36).substr(2, 8).toUpperCase()}`;
      shipment.token = token;
      shipment.tokenGeneratedAt = new Date().toISOString();
      shipment.status = 'token-generated';
      
      this.saveShipment(shipment);
      
      // Add notification for shipper
      this.addNotification({
        id: `notif-${Date.now()}-${Math.random()}`,
        type: 'broker-approved',
        title: 'Broker Approved Your Shipment',
        message: `${shipment.id}: Token generated - ${token}`,
        shipmentId: id,
        timestamp: new Date().toISOString(),
        read: false,
        recipientRole: 'shipper'
      });
    }
  }

  // Broker denies shipment
  brokerDeny(id, reason) {
    const shipment = this.getShipmentById(id);
    if (shipment) {
      shipment.brokerApproval = 'rejected';
      shipment.brokerReviewedAt = new Date().toISOString();
      shipment.brokerNotes = reason;
      shipment.status = 'denied';
      
      this.saveShipment(shipment);
      
      // Add system message
      this.addMessage({
        id: `msg-${Date.now()}`,
        shipmentId: id,
        sender: 'broker',
        senderName: 'Customs Broker',
        message: `Shipment denied: ${reason}`,
        timestamp: new Date().toISOString(),
        type: 'system'
      });
    }
  }

  // Broker requests documents
  brokerRequestDocuments(id, requestedDocs, message) {
    const shipment = this.getShipmentById(id);
    if (shipment) {
      shipment.brokerApproval = 'documents-requested';
      shipment.brokerReviewedAt = new Date().toISOString();
      shipment.brokerNotes = message;
      shipment.status = 'document-requested';
      
      // Mark documents as requested
      const now = new Date().toISOString();
      requestedDocs.forEach(doc => {
        const existingDoc = shipment.documents.find(d => d.name === doc.name);
        if (existingDoc) {
          existingDoc.requested = true;
          existingDoc.requestedAt = now;
        } else {
          shipment.documents.push({
            name: doc.name,
            type: doc.type,
            uploaded: false,
            requested: true,
            requestedAt: now
          });
        }
      });
      
      this.saveShipment(shipment);
      
      // Add chat message
      this.addMessage({
        id: `msg-${Date.now()}`,
        shipmentId: id,
        sender: 'broker',
        senderName: 'Customs Broker',
        message: `Documents requested: ${requestedDocs.map(d => d.name).join(', ')}. ${message}`,
        timestamp: now,
        type: 'document-request'
      });
    }
  }

  // Upload document
  uploadDocument(shipmentId, docName, docType) {
    const shipment = this.getShipmentById(shipmentId);
    if (shipment) {
      const doc = shipment.documents.find(d => d.name === docName);
      if (doc) {
        doc.uploaded = true;
        doc.uploadedAt = new Date().toISOString();
      } else {
        shipment.documents.push({
          name: docName,
          type: docType,
          uploaded: true,
          uploadedAt: new Date().toISOString()
        });
      }
      
      // Check if all requested documents are uploaded
      const allRequestedUploaded = shipment.documents
        .filter(d => d.requested)
        .every(d => d.uploaded);
      
      // If all requested documents are uploaded and status is document-requested,
      // don't automatically change status - let shipper choose to re-run AI or send to broker
      if (allRequestedUploaded && shipment.status === 'document-requested') {
        // Keep status as document-requested, update broker approval to allow resubmission
        shipment.brokerApproval = 'documents-requested';
        
        // Add notification for shipper
        this.addNotification({
          id: `notif-${Date.now()}-${Math.random()}`,
          type: 'documents-requested',
          title: 'Documents Uploaded',
          message: `All requested documents uploaded for shipment ${shipment.id}. You can now re-run AI check or send to broker.`,
          shipmentId: shipment.id,
          timestamp: new Date().toISOString(),
          read: false,
          recipientRole: 'shipper'
        });
      }
      
      this.saveShipment(shipment);
    }
  }

  // Book shipment
  bookShipment(id, bookingDate, estimatedDelivery, amount) {
    const shipment = this.getShipmentById(id);
    if (shipment && shipment.token) {
      shipment.bookingDate = bookingDate;
      shipment.estimatedDelivery = estimatedDelivery;
      shipment.paymentAmount = amount;
      shipment.paymentStatus = 'pending';
      shipment.status = 'ready-for-booking';
      
      this.saveShipment(shipment);
    }
  }

  // Complete payment
  completePayment(id) {
    const shipment = this.getShipmentById(id);
    if (shipment) {
      shipment.paymentStatus = 'completed';
      shipment.paymentDate = new Date().toISOString();
      shipment.status = 'payment-completed';
      
      this.saveShipment(shipment);
    }
  }

  // Chat messages
  getMessages(shipmentId) {
    if (shipmentId) {
      return this.messages.filter(m => m.shipmentId === shipmentId);
    }
    return [...this.messages];
  }

  addMessage(message) {
    this.messages.push(message);
    this.notify();
  }

  // Get unread message count for shipper
  getUnreadMessageCount(shipperId) {
    // Simulate unread messages - in real app would track read status
    return this.messages.filter(m => m.sender === 'broker').length;
  }

  // Notifications
  getNotifications(role) {
    return this.notifications.filter(n => n.recipientRole === role);
  }

  addNotification(notification) {
    this.notifications.push(notification);
    this.notify();
  }

  markNotificationAsRead(notificationId) {
    const notification = this.notifications.find(n => n.id === notificationId);
    if (notification) {
      notification.read = true;
      this.notify();
    }
  }

  // Import/Export Rules
  getImportExportRules() {
    return [...this.importExportRules];
  }

  addImportExportRule(rule) {
    this.importExportRules.push(rule);
    this.notify();
  }

  updateImportExportRule(id, updatedRule) {
    const index = this.importExportRules.findIndex(r => r.id === id);
    if (index >= 0) {
      this.importExportRules[index] = updatedRule;
      this.notify();
    }
  }

  deleteImportExportRule(id) {
    const index = this.importExportRules.findIndex(r => r.id === id);
    if (index >= 0) {
      this.importExportRules.splice(index, 1);
      this.notify();
    }
  }
}

// Export singleton instance
export const shipmentsStore = new ShipmentsStore();

